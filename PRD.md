# Завдання на Розробку (ЗнР): MPC-сервер для Завантаження Відео з YouTube

## 1. Вступ та Огляд Проєкту

*   **1.1. Назва Проєкту:** YouTube Downloader Local MCP Server
*   **1.2. Мета:** Розробити **локальний** сервер на основі Model Context Protocol (MCP), який надаватиме інструменти для завантаження відео та аудіо з YouTube. Сервер буде інтегруватися з LLM-додатками (MCP-клієнтами), дозволяючи користувачам взаємодіяти з функціоналом завантаження через природну мову або програмні запити, виконуючи всі операції на машині користувача.
*   **1.3. Технологічний Стек:**
    *   Мова програмування: TypeScript
    *   Середовище виконання: Node.js
    *   Шаблон MCP-сервера: [@Custom MCP Template](https://github.com/bsmi021/custom-mcp-template)
    *   Інструмент для завантаження відео: `yt-dlp` (викликатиметься як локальний CLI-інструмент)
    *   **Відповідність специфікації MCP:** Сервер **ПОВИНЕН** повністю відповідати актуальній стабільній версії специфікації Model Context Protocol (на момент розробки – версія від 2025-03-26 або новіша стабільна). Це включає структуру повідомлень JSON-RPC 2.0, механізми обробки запитів/відповідей, реєстрацію інструментів та обробку помилок (`McpError`).

## 2. Цілі та Завдання Проєкту

*   **2.1. Головна Ціль:** Надати стандартизований, безпечний та **виключно локально** розгортуваний інтерфейс для завантаження контенту з YouTube через MCP, використовуючи потужності `yt-dlp` на комп'ютері користувача.
*   **2.2. Конкретні Завдання:**
    *   Реалізувати **локальний** MCP-сервер на Node.js/TypeScript, базуючись на `@Custom MCP Template`.
    *   Визначити та реалізувати набір MCP-інструментів (`tools`), які відображатимуть основні функції `yt-dlp`.
    *   Забезпечити обробку параметрів від MCP-клієнта та їх коректну передачу в `yt-dlp`.
    *   Забезпечити повернення результатів (статус завантаження, помилки, шлях до завантаженого файлу, метадані) MCP-клієнту.
    *   Дотримуватися принципів безпеки та згоди користувача, визначених у специфікації MCP, в контексті локального сервера.
    *   Забезпечити конфігурованість сервера (шляхи до `yt-dlp`, `ffmpeg`, шляхи збереження).

## 3. Цільова Аудиторія

*   Розробники LLM-додатків, які хочуть інтегрувати функціонал завантаження YouTube-відео у свої продукти, використовуючи **локальний** MCP-сервер.
*   Користувачі MCP-сумісних клієнтів, які мають можливість запустити та підключитися до **локального** MCP-сервера для завантаження відео з YouTube.

## 4. Функціональні Вимоги

*   **4.1. Взаємодія за Протоколом MCP**
    *   **4.1.1. Реєстрація Сервера:** Сервер **ПОВИНЕН** коректно реєструватися та повідомляти про свої можливості (надані інструменти) MCP-клієнтам.
    *   **4.1.2. Обробка Запитів Інструментів:** Сервер **ПОВИНЕН** приймати запити на виклик інструментів (`tool_calls`) від MCP-клієнтів, парсити передані параметри (використовуючи Zod, як рекомендовано шаблоном).
    *   **4.1.3. Повернення Результатів Інструментів:** Сервер **ПОВИНЕН** повертати результати виконання інструментів (`tool_results`) MCP-клієнтам, включаючи як успішні результати, так і інформацію про помилки у форматі `McpError`.
    *   **4.1.4. Підтримка JSON-RPC 2.0:** Вся комунікація **ПОВИННА** відповідати формату JSON-RPC 2.0.

*   **4.2. Основні Інструменти (`tools`) для `yt-dlp`**
    *   **4.2.1. Інструмент: `download_video`**
        *   **Опис:** Завантажує відео (та/або аудіо) за вказаним URL з YouTube з можливістю вказання бажаної якості та форматів контейнерів.
        *   **Вхідні параметри (визначені через Zod):**
            *   `url` (string, обов'язковий): URL відео на YouTube.
            *   `quality_preference` (string, опціональний, за замовчуванням "best"): Бажана якість/вибір основного формату (наприклад, "best", "worst", "720p", "1080p", "bestvideo", "bestaudio").
            *   `video_container_preference` (string, опціональний): Бажаний контейнер для відео (наприклад, "mp4", "webm", "mkv").
            *   `audio_container_preference` (string, опціональний): Бажаний контейнер для аудіо (наприклад, "m4a", "opus", "ogg", "mp3").
            *   `output_path` (string, опціональний): Локальний шлях для збереження файлу. Якщо не вказано, використовується тимчасовий або шлях за замовчуванням, визначений у конфігурації сервера.
            *   `extract_audio_only` (boolean, опціональний, за замовчуванням `false`): Якщо `true`, завантажує лише аудіодоріжку.
        *   **Вихідні дані (успіх):**
            *   `status` (string): "success"
            *   `message` (string): "Відео успішно завантажено." (або "Аудіо успішно вилучено.")
            *   `file_path` (string): Абсолютний локальний шлях до завантаженого файлу.
            *   `filename` (string): Назва завантаженого файлу.
            *   `final_video_format` (string, опціональний): Фактичний формат відео, в якому було завантажено.
            *   `final_audio_format` (string, опціональний): Фактичний формат аудіо, в якому було завантажено/вилучено.
            *   `metadata` (object, опціональний): Додаткові метадані про відео.
        *   **Вихідні дані (помилка):** (Обробляється через `McpError`)
            *   `status` (string): "error"
            *   `message` (string): Опис помилки.

    *   **4.2.2. Інструмент: `get_video_info`**
        *   **Опис:** Отримує інформацію про відео (метадані та доступні формати) без фактичного завантаження.
        *   **Вхідні параметри (визначені через Zod):**
            *   `url` (string, обов'язковий): URL відео на YouTube.
        *   **Вихідні дані (успіх):**
            *   `status` (string): "success"
            *   `video_title` (string): Назва відео.
            *   `uploader` (string): Автор відео.
            *   `duration` (integer): Тривалість відео в секундах.
            *   `thumbnail_url` (string): URL обкладинки відео.
            *   `available_formats` (array of objects): Список доступних форматів.
        *   **Вихідні дані (помилка):** (Обробляється через `McpError`)
            *   `status` (string): "error"
            *   `message` (string): Опис помилки.

*   **4.3. Обробка Завантажених Файлів**
    *   **4.3.1. Збереження Файлів:** Сервер зберігає файли у **локальній** файловій системі за шляхом, вказаним користувачем або за шляхом за замовчуванням з конфігурації.
    *   **4.3.2. Доступ до Файлів:** Клієнт отримує **локальний** шлях до файлу. Відповідальність за подальшу роботу з файлом лежить на клієнті або користувачеві.
    *   **4.3.3. Очищення Файлів:** Сервер не відповідає за автоматичне очищення файлів, якщо шлях збереження вказаний користувачем.

## 5. Нефункціональні Вимоги

*   **5.1. Продуктивність**
    *   **5.1.1. Час Відповіді Сервера (без `yt-dlp`):** Для запитів, що не вимагають запуску `yt-dlp` (наприклад, отримання інформації про відео через `--dump-json`, валідація параметрів), середній час відповіді сервера **ПОВИНЕН** бути ≤ 1 секунди, а 95-й перцентиль ≤ 2 секунди при типовому навантаженні на машину розробника.
    *   **5.1.2. Ефективність Використання Ресурсів (серверна логіка):** Споживання CPU процесом Node.js для обробки MCP запитів (без урахування `yt-dlp`) **ПОВИННО** бути < 5% на типовій машині розробника в стані спокою та < 15% під час активної обробки метаданих.
    *   **5.1.3. Обробка Паралельних Запитів `yt-dlp`:** Сервер **ПОВИНЕН** бути здатний асинхронно обробляти щонайменше 3 одночасних виклики `yt-dlp` без блокування обробки нових MCP-запитів (фактична кількість паралельних завантажень обмежується ресурсами машини користувача).

*   **5.2. Надійність**
    *   **5.2.1. Обробка Помилок `yt-dlp`:** 100% кодів повернення `yt-dlp`, що вказують на помилку, **ПОВИННІ** коректно перехоплюватися та трансформуватися у відповідний `McpError` з інформативним повідомленням.
    *   **5.2.2. Стійкість до Некоректних Вхідних Даних:** 100% вхідних параметрів для інструментів **ПОВИННІ** валідуватися за допомогою Zod-схем. Невалідні запити **ПОВИННІ** генерувати відповідний `McpError`.
    *   **5.2.3. Логування:** Усі критичні помилки сервера та основні етапи обробки запитів (включаючи команди, що передаються `yt-dlp`) **ПОВИННІ** логуватися з використанням структурованого JSON-формату. Рівень логування **ПОВИНЕН** бути конфігурованим.

*   **5.3. Безпека**
    *   **5.3.1. Запобігання Command Injection:** Усі параметри, що передаються до `yt-dlp` як частина команди, **ПОВИННІ** проходити санітизацію та/або використовувати безпечні методи побудови команд, щоб унеможливити Command Injection (0 виявлених вразливостей при тестуванні).
    *   **5.3.2. Безпека Доступу до Файлів:** Шлях `output_path`, наданий користувачем, **ПОВИНЕН** валідуватися, щоб унеможливити запис поза межами визначеного користувачем (або за замовчуванням) каталогу завантажень (0 виявлених вразливостей path traversal).

*   **5.4. Масштабованість**
    *   Не застосовується в контексті **локального** сервера, продуктивність якого обмежується ресурсами однієї машини.

*   **5.5. Супроводжуваність та Тестованість**
    *   **5.5.1. Читабельність Коду:** Середня цикломатична складність функцій у модулях сервісів та інструментів **ПОВИННА** бути ≤ 10. Код **ПОВИНЕН** відповідати налаштованим правилам ESLint/Prettier на 100%.
    *   **5.5.2. Модульність:** Структура проєкту **ПОВИННА** суворо відповідати рекомендаціям `@Custom MCP Template`.
    *   **5.5.3. Тестове Покриття:** Юніт-тести **ПОВИННІ** покривати щонайменше 70% коду в модулях сервісів (`src/services/`).

*   **5.6. Залежності**
    *   **5.6.1. `yt-dlp`:** Наявність у системі та доступність для виклику.
    *   **5.6.2. `ffmpeg`:** Наявність у системі та доступність для виклику (рекомендовано).

*   **5.7. Конфігурованість**
    *   **5.7.1. Шлях до `yt-dlp`:** Можливість конфігурувати через файл конфігурації або змінні середовища.
    *   **5.7.2. Шлях до `ffmpeg`:** Можливість конфігурувати через файл конфігурації або змінні середовища.
    *   **5.7.3. Параметри `yt-dlp` за замовчуванням:** Можливість задавати глобальні параметри для `yt-dlp`.
    *   **5.7.4. Шлях для збереження файлів за замовчуванням:** Конфігурований шлях.
    *   **5.7.5. Налаштування Cookies (опціонально):** Розглянути можливість вказання шляху до файлу cookies для `yt-dlp`.

## 6. Архітектура Системи

*   **6.1. Огляд Компонентів:**
    *   **MCP Клієнт (LLM Додаток)**
    *   **Локальний MCP Сервер (Node.js/TypeScript Додаток на базі `@Custom MCP Template`):** **Локальний** сервер, що виконується на машині користувача.
        *   `src/server.ts` (точка входу)
        *   `src/initialize.ts` (реєстрація інструментів)
        *   `src/tools/` (`youtubeDownloadTool.ts`, `youtubeVideoInfoTool.ts`, `*Params.ts`)
        *   `src/services/` (`YoutubeDownloadService.ts`)
        *   `src/config/` (`ConfigurationManager`)
        *   `src/types/` (Інтерфейси, Zod схеми)
        *   `src/utils/` (Логер, обробка помилок)
    *   **`yt-dlp` (CLI інструмент):** **Локально** встановлений.
    *   **`ffmpeg` (CLI інструмент, опціонально):** **Локально** встановлений.
    *   **Локальна Файлова Система:** Використовується для збереження завантажених файлів на машині користувача.
    *   **Файл Конфігурації / Змінні Середовища**

*   **6.2. Потік Даних (Приклад: `download_video`)**
    1.  MCP Клієнт -> **Локальний** MCP Сервер (`tool_call`).
    2.  `*Tool.ts` валідує параметри (Zod).
    3.  `*Tool.ts` викликає `YoutubeDownloadService.ts`.
    4.  `YoutubeDownloadService` формує команду `yt-dlp`.
    5.  Сервіс запускає `yt-dlp` через `child_process`.
    6.  `yt-dlp` завантажує файл у **локальну** файлову систему.
    7.  Сервіс обробляє вивід/помилки `yt-dlp`.
    8.  Сервіс повертає результат/помилку у `*Tool.ts`.
    9.  `*Tool.ts` форматує `tool_result` (або `McpError`).
    10. **Локальний** MCP Сервер -> MCP Клієнт.

*   **6.3. Взаємодія з `yt-dlp` та `ffmpeg`**
    *   Через `child_process` в Node.js.
    *   Безпечна побудова команд.
    *   Конфігуровані шляхи до виконуваних файлів.

## 7. Ризики та Їх Мінімізація

*   **7.1. Технічні Ризики**
    *   Проблеми з `child_process` на різних ОС -> Ретельне тестування, логування.
    *   Блокування основного потоку Node.js -> Асинхронні виклики `child_process`.
    *   Управління **локальним** сховищем (місце, права) -> Конфігурація шляху, інструкції.
    *   Залежність від **локально** встановлених `yt-dlp`/`ffmpeg` -> Документація, перевірка при старті, конфігурація шляхів.

*   **7.2. Ризики Безпеки**
    *   Command Injection -> Сувора валідація (Zod), екранування параметрів.
    *   Доступ до довільних файлів через `output_path` -> Валідація шляху, обмеження дозволеними каталогами.

*   **7.3. Юридичні Ризики та Відповідність Умовам Використання**
    *   Порушення авторських прав -> Відповідальність користувача, сервер – інструмент.

*   **7.4. Ризики Реалізації Проєкту**
    *   Недооцінка інтеграції з `@Custom MCP Template` -> Вивчення шаблону, PoC.

## 8. План Розгортання та Вимоги до Середовища

*   **8.1. Вимоги до Середовища Кінцевого Користувача (для запуску локального сервера):**
    *   ОС: Windows, macOS, Linux.
    *   Node.js: Актуальна LTS (наприклад, >=18.x).
    *   `yt-dlp`: **Локально** встановлений.
    *   `ffmpeg` (рекомендовано): **Локально** встановлений.
    *   Доступ до Інтернету.
    *   Дисковий Простір.

*   **8.2. Процес Розгортання **Локального** Сервера:**
    1.  Клонувати репозиторій.
    2.  `npm install`.
    3.  Налаштувати конфігурацію (шляхи до `yt-dlp`/`ffmpeg`, шлях збереження).
    4.  `npm run build` (для TypeScript).
    5.  `npm start`.

*   **8.3. Інтеграція з MCP-Клієнтами:** Налаштування клієнтів на `localhost:[порт_сервера]` для підключення до **локального** сервера.

## 9. Майбутні Можливості

*   Розширений вибір форматів.
*   Завантаження плейлистів.
*   Завантаження субтитрів.
*   Керування активними завантаженнями (статус, скасування).
*   Підтримка інших відеохостингів.

## 10. Додатки

*   **10.1. Специфікація MCP:** [https://modelcontextprotocol.io/specification/](https://modelcontextprotocol.io/specification/)
*   **10.2. Документація `yt-dlp`:** [https://github.com/yt-dlp/yt-dlp](https://github.com/yt-dlp/yt-dlp)
*   **10.3. `@Custom MCP Template`:** [https://github.com/bsmi021/custom-mcp-template](https://github.com/bsmi021/custom-mcp-template) 